<!-- CPUE Results Component -->
<div id="cpueResultsContainer" class="professional-card p-6 hidden">
    <h3 class="text-xl font-bold mb-4">
        CPUE 분석 결과
        <button onclick="exportCPUEResults()" class="float-right text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
            결과 내보내기
        </button>
    </h3>
    
    <!-- 요약 통계 -->
    <div class="grid grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">평균 CPUE</p>
            <p class="text-2xl font-bold text-blue-600" id="cpueMean">-</p>
            <p class="text-xs text-gray-500" id="cpueUnit">-</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">표준편차</p>
            <p class="text-2xl font-bold text-green-600" id="cpueStd">-</p>
            <p class="text-xs text-gray-500">±</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">변동계수</p>
            <p class="text-2xl font-bold text-purple-600" id="cpueCV">-</p>
            <p class="text-xs text-gray-500">%</p>
        </div>
        <div class="bg-orange-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">데이터 수</p>
            <p class="text-2xl font-bold text-orange-600" id="cpueN">-</p>
            <p class="text-xs text-gray-500">개</p>
        </div>
    </div>
    
    <!-- CPUE 추세 그래프 -->
    <div class="mb-6">
        <h4 class="text-lg font-semibold mb-3">CPUE 추세</h4>
        <div class="bg-white p-4 border rounded-lg">
            <canvas id="cpueTrendChart" width="400" height="200"></canvas>
        </div>
        <div id="cpueTrendInterpretation" class="mt-2 p-3 bg-gray-50 rounded text-sm">
            <!-- 추세 해석 결과 -->
        </div>
    </div>
    
    <!-- 계절성 분석 (옵션) -->
    <div id="cpueSeasonalityResults" class="mb-6 hidden">
        <h4 class="text-lg font-semibold mb-3">계절성 패턴</h4>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 border rounded-lg">
                <canvas id="cpueSeasonalChart" width="200" height="150"></canvas>
            </div>
            <div class="p-4">
                <h5 class="font-medium mb-2">계절별 평균 CPUE</h5>
                <div id="cpueSeasonalTable" class="space-y-2">
                    <!-- 계절별 통계 테이블 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 이상치 탐지 (옵션) -->
    <div id="cpueAnomalyResults" class="mb-6 hidden">
        <h4 class="text-lg font-semibold mb-3">이상치 탐지 결과</h4>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <div class="flex-1">
                    <p class="font-medium text-yellow-800">
                        <span id="cpueAnomalyCount">0</span>개의 이상치 탐지됨
                    </p>
                    <ul id="cpueAnomalyList" class="mt-2 text-sm text-yellow-700 space-y-1">
                        <!-- 이상치 목록 -->
                    </ul>
                    <p id="cpueAnomalyRecommendation" class="mt-2 text-sm text-yellow-600">
                        <!-- 권장사항 -->
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 해역별/어종별 비교 (다중 그룹인 경우) -->
    <div id="cpueComparisonResults" class="mb-6 hidden">
        <h4 class="text-lg font-semibold mb-3">그룹별 CPUE 비교</h4>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 border rounded-lg">
                <canvas id="cpueComparisonChart" width="200" height="150"></canvas>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">그룹</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">평균 CPUE</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">표준편차</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">우세도(%)</th>
                        </tr>
                    </thead>
                    <tbody id="cpueComparisonTable" class="bg-white divide-y divide-gray-200">
                        <!-- 그룹별 통계 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 예측 결과 (옵션) -->
    <div id="cpueForecastResults" class="mb-6 hidden">
        <h4 class="text-lg font-semibold mb-3">CPUE 예측</h4>
        <div class="bg-white p-4 border rounded-lg">
            <canvas id="cpueForecastChart" width="400" height="200"></canvas>
        </div>
        <div class="mt-3 p-3 bg-blue-50 rounded">
            <p class="text-sm font-medium text-blue-800 mb-1">예측 정확도</p>
            <div class="grid grid-cols-3 gap-4 text-sm">
                <div>
                    <span class="text-gray-600">MAE:</span>
                    <span id="cpueForecastMAE" class="font-medium">-</span>
                </div>
                <div>
                    <span class="text-gray-600">RMSE:</span>
                    <span id="cpueForecastRMSE" class="font-medium">-</span>
                </div>
                <div>
                    <span class="text-gray-600">MAPE:</span>
                    <span id="cpueForecastMAPE" class="font-medium">-</span>%
                </div>
            </div>
        </div>
    </div>
    
    <!-- 상세 데이터 테이블 -->
    <div class="mb-6">
        <h4 class="text-lg font-semibold mb-3">
            상세 데이터
            <button onclick="toggleCPUEDataTable()" class="text-sm text-blue-600 ml-2">
                [펼치기/접기]
            </button>
        </h4>
        <div id="cpueDataTable" class="hidden overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">번호</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">어획량</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">어획노력</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">CPUE</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">상태</th>
                    </tr>
                </thead>
                <tbody id="cpueDataTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- 데이터 행 -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 해석 및 권장사항 -->
    <div class="bg-gray-50 p-4 rounded-lg">
        <h4 class="text-lg font-semibold mb-3">종합 해석</h4>
        <div id="cpueInterpretation" class="space-y-2 text-sm">
            <!-- 종합 해석 내용 -->
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-200">
            <h5 class="font-medium mb-2">권장사항</h5>
            <ul id="cpueRecommendations" class="space-y-1 text-sm text-gray-700">
                <!-- 권장사항 목록 -->
            </ul>
        </div>
    </div>
    
    <!-- 액션 버튼 -->
    <div class="mt-6 flex gap-4">
        <button onclick="printCPUEReport()" class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
            보고서 인쇄
        </button>
        <button onclick="saveCPUEResults()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
            결과 저장
        </button>
        <button onclick="resetCPUEAnalysis()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
            새 분석
        </button>
    </div>
</div>

<script>
// CPUE 결과 표시
function displayCPUEResults(results) {
    // 컨테이너 표시
    document.getElementById('cpueResultsContainer').classList.remove('hidden');
    
    // 요약 통계 표시
    document.getElementById('cpueMean').textContent = results.statistics.mean.toFixed(2);
    document.getElementById('cpueStd').textContent = results.statistics.std.toFixed(2);
    document.getElementById('cpueCV').textContent = results.statistics.cv.toFixed(1);
    document.getElementById('cpueN').textContent = results.statistics.n;
    document.getElementById('cpueUnit').textContent = results.unit;
    
    // 추세 그래프 그리기
    drawCPUETrendChart(results);
    
    // 추세 해석
    if (results.trend) {
        displayCPUETrendInterpretation(results.trend);
    }
    
    // 계절성 결과 (있는 경우)
    if (results.trend && results.trend.seasonality) {
        displaySeasonalityResults(results.trend.seasonality);
    }
    
    // 이상치 결과 (있는 경우)
    if (results.anomalies) {
        displayAnomalyResults(results.anomalies);
    }
    
    // 상세 데이터 테이블
    populateCPUEDataTable(results);
    
    // 종합 해석
    generateCPUEInterpretation(results);
}

// CPUE 추세 그래프
function drawCPUETrendChart(results) {
    const ctx = document.getElementById('cpueTrendChart').getContext('2d');
    const labels = results.cpue.map((_, i) => `${i + 1}`);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'CPUE',
                data: results.cpue,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1
            }, {
                label: '평균',
                data: Array(results.cpue.length).fill(results.statistics.mean),
                borderColor: 'rgb(239, 68, 68)',
                borderDash: [5, 5],
                borderWidth: 1,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                title: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: `CPUE (${results.unit})`
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '관측 번호'
                    }
                }
            }
        }
    });
}

// 추세 해석 표시
function displayCPUETrendInterpretation(trend) {
    const container = document.getElementById('cpueTrendInterpretation');
    const direction = trend.trend.direction;
    const strength = trend.trend.strength;
    
    container.innerHTML = `
        <p class="font-medium mb-1">추세 분석 결과</p>
        <ul class="space-y-1 text-xs">
            <li>• 추세 방향: <span class="font-medium">${direction}</span></li>
            <li>• 기울기: ${trend.trend.slope.toFixed(4)}</li>
            <li>• 추세 강도: ${strength.toFixed(4)}</li>
            ${trend.changePoints && trend.changePoints.length > 0 ? 
                `<li>• 변화점 탐지: ${trend.changePoints.length}개 지점</li>` : ''}
        </ul>
    `;
}

// 계절성 결과 표시
function displaySeasonalityResults(seasonality) {
    if (!seasonality.hasSeasonality) return;
    
    document.getElementById('cpueSeasonalityResults').classList.remove('hidden');
    
    // 계절별 차트
    const ctx = document.getElementById('cpueSeasonalChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Q1', 'Q2', 'Q3', 'Q4'],
            datasets: [{
                label: '분기별 평균 CPUE',
                data: seasonality.quarterlyMeans,
                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// 이상치 결과 표시
function displayAnomalyResults(anomalies) {
    if (anomalies.anomalies.length === 0) return;
    
    document.getElementById('cpueAnomalyResults').classList.remove('hidden');
    document.getElementById('cpueAnomalyCount').textContent = anomalies.anomalies.length;
    
    const list = document.getElementById('cpueAnomalyList');
    list.innerHTML = anomalies.anomalies.map(a => 
        `<li>• 관측 ${a.index + 1}: CPUE = ${a.value.toFixed(2)} (Z-score: ${a.zScore.toFixed(2)})</li>`
    ).join('');
    
    document.getElementById('cpueAnomalyRecommendation').textContent = anomalies.recommendation;
}

// 상세 데이터 테이블
function populateCPUEDataTable(results) {
    const tbody = document.getElementById('cpueDataTableBody');
    tbody.innerHTML = '';
    
    results.cpue.forEach((cpue, i) => {
        const row = document.createElement('tr');
        const isAnomaly = results.anomalies?.anomalies.some(a => a.index === i);
        
        row.innerHTML = `
            <td class="px-3 py-2">${i + 1}</td>
            <td class="px-3 py-2 text-right">${results.catchData ? results.catchData[i].toFixed(2) : '-'}</td>
            <td class="px-3 py-2 text-right">${results.effortData ? results.effortData[i].toFixed(2) : '-'}</td>
            <td class="px-3 py-2 text-right font-medium">${cpue.toFixed(3)}</td>
            <td class="px-3 py-2 text-center">
                ${isAnomaly ? 
                    '<span class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded">이상치</span>' : 
                    '<span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">정상</span>'}
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// 종합 해석 생성
function generateCPUEInterpretation(results) {
    const interpretationDiv = document.getElementById('cpueInterpretation');
    const recommendationsUl = document.getElementById('cpueRecommendations');
    
    const interpretations = [];
    const recommendations = [];
    
    // CPUE 수준 해석
    interpretations.push(`<p>• 평균 CPUE: ${results.statistics.mean.toFixed(2)} ${results.unit}</p>`);
    interpretations.push(`<p>• 변동성: ${results.interpretation}</p>`);
    
    // 추세 해석
    if (results.trend) {
        const trendDir = results.trend.trend.direction;
        interpretations.push(`<p>• CPUE 추세: ${trendDir}</p>`);
        
        if (trendDir === '감소') {
            recommendations.push('<li>• 자원 감소 가능성 검토 필요</li>');
            recommendations.push('<li>• 어획 강도 조절 고려</li>');
        } else if (trendDir === '증가') {
            recommendations.push('<li>• 자원 회복 신호일 수 있음</li>');
            recommendations.push('<li>• 지속적인 모니터링 필요</li>');
        }
    }
    
    // 이상치 관련
    if (results.anomalies && results.anomalies.anomalies.length > 0) {
        recommendations.push('<li>• 이상치 발생 원인 조사 필요</li>');
    }
    
    interpretationDiv.innerHTML = interpretations.join('');
    recommendationsUl.innerHTML = recommendations.length > 0 ? recommendations.join('') : '<li>• 현재 수준 유지 권장</li>';
}

// 테이블 토글
function toggleCPUEDataTable() {
    document.getElementById('cpueDataTable').classList.toggle('hidden');
}

// 결과 내보내기
function exportCPUEResults() {
    // Excel 또는 CSV로 내보내기 로직
    console.log('CPUE 결과 내보내기');
}

// 보고서 인쇄
function printCPUEReport() {
    window.print();
}

// 결과 저장
function saveCPUEResults() {
    // 로컬 스토리지 또는 파일로 저장
    const results = {
        timestamp: new Date().toISOString(),
        // ... 결과 데이터
    };
    localStorage.setItem('cpueResults', JSON.stringify(results));
    alert('결과가 저장되었습니다.');
}

// 새 분석
function resetCPUEAnalysis() {
    document.getElementById('cpueResultsContainer').classList.add('hidden');
    clearCPUEInput();
}
</script>