<!-- CPUE Input Component -->
<div id="cpueInputContainer" class="professional-card p-6">
    <h3 class="text-xl font-bold mb-4">
        CPUE (Catch Per Unit Effort) 분석
        <span class="tooltip-trigger text-sm text-blue-500 cursor-help" 
              onmouseover="showTooltip(event, '어획노력당 어획량 분석: 어업 자원의 상대적 풍도 평가')" 
              onmouseout="hideTooltip()">ⓘ</span>
    </h3>
    
    <!-- 입력 방식 선택 -->
    <div class="mb-6">
        <label class="block text-sm font-medium mb-2">데이터 입력 방식</label>
        <div class="flex gap-4">
            <label class="flex items-center">
                <input type="radio" name="cpueInputMethod" value="manual" checked 
                       onchange="toggleCPUEInputMethod('manual')" class="mr-2">
                <span>직접 입력</span>
            </label>
            <label class="flex items-center">
                <input type="radio" name="cpueInputMethod" value="file" 
                       onchange="toggleCPUEInputMethod('file')" class="mr-2">
                <span>파일 업로드</span>
            </label>
            <label class="flex items-center">
                <input type="radio" name="cpueInputMethod" value="timeseries" 
                       onchange="toggleCPUEInputMethod('timeseries')" class="mr-2">
                <span>시계열 데이터</span>
            </label>
        </div>
    </div>
    
    <!-- 직접 입력 폼 -->
    <div id="cpueManualInput" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <!-- 어획량 입력 -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    어획량 (Catch)
                    <span class="text-xs text-gray-500 ml-1">콤마로 구분</span>
                </label>
                <textarea id="cpueCatchData" rows="3" 
                          placeholder="예: 100, 150, 120, 180, 160"
                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <!-- 어획노력 입력 -->
            <div>
                <label class="block text-sm font-medium mb-2">
                    어획노력 (Effort)
                    <span class="text-xs text-gray-500 ml-1">콤마로 구분</span>
                </label>
                <textarea id="cpueEffortData" rows="3" 
                          placeholder="예: 10, 12, 11, 15, 13"
                          class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
        </div>
        
        <!-- 단위 선택 -->
        <div class="grid grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">어획량 단위</label>
                <select id="cpueCatchUnit" class="w-full p-2 border rounded-lg">
                    <option value="kg">kg (킬로그램)</option>
                    <option value="ton">톤 (ton)</option>
                    <option value="n">마리수 (개체수)</option>
                    <option value="basket">바구니</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">노력 단위</label>
                <select id="cpueEffortUnit" class="w-full p-2 border rounded-lg">
                    <option value="hour">시간 (hour)</option>
                    <option value="day">일 (day)</option>
                    <option value="haul">투망 횟수</option>
                    <option value="vessel">척수</option>
                    <option value="trip">조업 횟수</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">결과 CPUE 단위</label>
                <input type="text" id="cpueResultUnit" readonly 
                       value="kg/hour" 
                       class="w-full p-2 border rounded-lg bg-gray-50">
            </div>
        </div>
    </div>
    
    <!-- 파일 업로드 폼 -->
    <div id="cpueFileInput" class="hidden">
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
            <input type="file" id="cpueFileUpload" accept=".csv,.xlsx,.xls" class="hidden"
                   onchange="handleCPUEFileUpload(event)">
            <label for="cpueFileUpload" class="cursor-pointer">
                <div class="mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <p class="text-sm text-gray-600">클릭하여 파일 선택 또는 드래그 앤 드롭</p>
                <p class="text-xs text-gray-500 mt-1">CSV, Excel 파일 지원</p>
            </label>
        </div>
        
        <!-- 파일 형식 안내 -->
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
            <p class="text-sm font-medium text-blue-800 mb-1">파일 형식 안내</p>
            <ul class="text-xs text-blue-600 space-y-1">
                <li>• 첫 번째 열: 날짜/시간 (선택사항)</li>
                <li>• 두 번째 열: 어획량 (Catch)</li>
                <li>• 세 번째 열: 어획노력 (Effort)</li>
                <li>• 네 번째 열: 해역/어종 (선택사항)</li>
            </ul>
        </div>
    </div>
    
    <!-- 시계열 데이터 입력 -->
    <div id="cpueTimeSeriesInput" class="hidden">
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">기간 설정</label>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="text-xs text-gray-500">시작일</label>
                    <input type="date" id="cpueStartDate" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="text-xs text-gray-500">종료일</label>
                    <input type="date" id="cpueEndDate" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="text-xs text-gray-500">주기</label>
                    <select id="cpuePeriod" class="w-full p-2 border rounded-lg">
                        <option value="daily">일별</option>
                        <option value="weekly">주별</option>
                        <option value="monthly" selected>월별</option>
                        <option value="quarterly">분기별</option>
                        <option value="yearly">연별</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 시계열 데이터 테이블 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">기간</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">어획량</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">어획노력</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">CPUE</th>
                    </tr>
                </thead>
                <tbody id="cpueTimeSeriesTable" class="bg-white divide-y divide-gray-200">
                    <!-- 동적으로 생성됨 -->
                </tbody>
            </table>
        </div>
        
        <button onclick="addCPUETimeSeriesRow()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
            + 데이터 추가
        </button>
    </div>
    
    <!-- 추가 옵션 -->
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
        <h4 class="text-sm font-medium mb-3">분석 옵션</h4>
        <div class="space-y-2">
            <label class="flex items-center">
                <input type="checkbox" id="cpueStandardize" class="mr-2">
                <span class="text-sm">표준화 CPUE 계산</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" id="cpueTrend" checked class="mr-2">
                <span class="text-sm">추세 분석 포함</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" id="cpueSeasonality" class="mr-2">
                <span class="text-sm">계절성 분석</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" id="cpueAnomaly" class="mr-2">
                <span class="text-sm">이상치 탐지</span>
            </label>
        </div>
    </div>
    
    <!-- 분석 버튼 -->
    <div class="mt-6 flex gap-4">
        <button onclick="analyzeCPUE()" 
                class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
            CPUE 분석 실행
        </button>
        <button onclick="clearCPUEInput()" 
                class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            초기화
        </button>
    </div>
    
    <!-- 샘플 데이터 -->
    <div class="mt-4">
        <button onclick="loadCPUESampleData()" 
                class="text-sm text-blue-600 hover:text-blue-800">
            샘플 데이터 불러오기
        </button>
    </div>
</div>

<script>
// CPUE 입력 방식 전환
function toggleCPUEInputMethod(method) {
    document.getElementById('cpueManualInput').classList.toggle('hidden', method !== 'manual');
    document.getElementById('cpueFileInput').classList.toggle('hidden', method !== 'file');
    document.getElementById('cpueTimeSeriesInput').classList.toggle('hidden', method !== 'timeseries');
}

// CPUE 단위 자동 업데이트
document.getElementById('cpueCatchUnit')?.addEventListener('change', updateCPUEUnit);
document.getElementById('cpueEffortUnit')?.addEventListener('change', updateCPUEUnit);

function updateCPUEUnit() {
    const catchUnit = document.getElementById('cpueCatchUnit').value;
    const effortUnit = document.getElementById('cpueEffortUnit').value;
    document.getElementById('cpueResultUnit').value = `${catchUnit}/${effortUnit}`;
}

// CPUE 파일 업로드 처리
function handleCPUEFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        // 파일 파싱 로직
        parseCPUEFile(e.target.result, file.name);
    };
    
    if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
    } else {
        reader.readAsArrayBuffer(file);
    }
}

// 시계열 행 추가
function addCPUETimeSeriesRow() {
    const tbody = document.getElementById('cpueTimeSeriesTable');
    const rowCount = tbody.children.length;
    const row = document.createElement('tr');
    
    row.innerHTML = `
        <td class="px-3 py-2">
            <input type="text" placeholder="2024-01" class="w-full p-1 border rounded">
        </td>
        <td class="px-3 py-2">
            <input type="number" placeholder="0" class="w-full p-1 border rounded">
        </td>
        <td class="px-3 py-2">
            <input type="number" placeholder="0" class="w-full p-1 border rounded">
        </td>
        <td class="px-3 py-2 text-center">
            <span class="text-gray-500">-</span>
        </td>
    `;
    
    tbody.appendChild(row);
}

// 샘플 데이터 로드
function loadCPUESampleData() {
    document.getElementById('cpueCatchData').value = '120, 150, 135, 180, 165, 145, 160, 175, 155, 170';
    document.getElementById('cpueEffortData').value = '10, 12, 11, 15, 13, 12, 14, 15, 13, 14';
    updateCPUEUnit();
}

// CPUE 분석 실행
async function analyzeCPUE() {
    const catchData = document.getElementById('cpueCatchData').value
        .split(',')
        .map(v => parseFloat(v.trim()))
        .filter(v => !isNaN(v));
    
    const effortData = document.getElementById('cpueEffortData').value
        .split(',')
        .map(v => parseFloat(v.trim()))
        .filter(v => !isNaN(v));
    
    if (catchData.length === 0 || effortData.length === 0) {
        alert('어획량과 어획노력 데이터를 입력해주세요.');
        return;
    }
    
    if (catchData.length !== effortData.length) {
        alert('어획량과 어획노력 데이터의 개수가 일치해야 합니다.');
        return;
    }
    
    // CPUE 분석 모듈 호출
    const cpueAnalysis = new CPUEAnalysis();
    const unit = document.getElementById('cpueResultUnit').value;
    
    const results = cpueAnalysis.calculateCPUE(catchData, effortData, unit);
    
    // 추가 분석 옵션
    if (document.getElementById('cpueTrend').checked) {
        const timePoints = Array.from({length: catchData.length}, (_, i) => i + 1);
        results.trend = cpueAnalysis.analyzeCPUETrend(results.cpue, timePoints);
    }
    
    if (document.getElementById('cpueAnomaly').checked) {
        results.anomalies = cpueAnalysis.detectAnomalies(results.cpue);
    }
    
    // 결과 표시
    displayCPUEResults(results);
}

// 입력 초기화
function clearCPUEInput() {
    document.getElementById('cpueCatchData').value = '';
    document.getElementById('cpueEffortData').value = '';
    document.getElementById('cpueTimeSeriesTable').innerHTML = '';
    document.querySelector('input[name="cpueInputMethod"][value="manual"]').checked = true;
    toggleCPUEInputMethod('manual');
}
</script>